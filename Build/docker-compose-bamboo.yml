version: '2.3'
services:
  mariadb10:
    image: mariadb:10
    environment:
      MYSQL_ROOT_PASSWORD: funcp
    tmpfs:
      - /var/lib/mysql/:rw,noexec,nosuid
    networks:
      - test

  start_dependencies:
    image: alpine:3.8
    links:
      - mariadb10
    networks:
      - test
    command: >
      /bin/sh -c "
        echo Waiting for database start
        COUNT=0
        while ! nc -z mariadb10 3306; do
          if [ "$${COUNT}" -ge "60" ]; then
            echo Database did not come up
            exit 1
          fi
          let "COUNT++"
          sleep 1
        done
        echo Database is up
      "

networks:
  test:
    external:
      name: ${BAMBOO_COMPOSE_PROJECT_NAME}_test

volumes:
  bamboo-data:
    external:
      name: ${BAMBOO_COMPOSE_PROJECT_NAME}_bamboo-data